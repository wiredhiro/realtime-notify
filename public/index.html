<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GCP Pub/Sub リアルタイム通知サービス</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .status-bar {
      background: white;
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
      animation: pulse 2s infinite;
    }

    .status-dot.connected {
      background: #22c55e;
    }

    .status-dot.disconnected {
      background: #ef4444;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .client-id {
      font-family: monospace;
      background: #f3f4f6;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .card h2 {
      color: #374151;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      color: #6b7280;
      margin-bottom: 5px;
      font-size: 14px;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .notifications-container {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .notification.info {
      background: #eff6ff;
      border-color: #3b82f6;
    }

    .notification.success {
      background: #f0fdf4;
      border-color: #22c55e;
    }

    .notification.warning {
      background: #fffbeb;
      border-color: #f59e0b;
    }

    .notification.error {
      background: #fef2f2;
      border-color: #ef4444;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .notification-title {
      font-weight: 600;
      color: #374151;
    }

    .notification-time {
      font-size: 12px;
      color: #9ca3af;
    }

    .notification-message {
      color: #6b7280;
      font-size: 14px;
    }

    .empty-state {
      text-align: center;
      color: #9ca3af;
      padding: 40px;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    .btn-secondary {
      background: #6b7280;
    }

    .btn-secondary:hover {
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
    }

    .pubsub-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 12px;
      background: #e5e7eb;
      color: #6b7280;
    }

    .pubsub-badge.enabled {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .pubsub-badge.disabled {
      background: #fef3c7;
      color: #b45309;
    }

    .notification-source {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 5px;
    }

    .notification-source.pubsub {
      color: #1d4ed8;
    }

    .notification-source.demo {
      color: #9333ea;
    }

    /* デモモードバナー */
    .demo-banner {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 12px 20px;
      text-align: center;
      font-weight: 600;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
      display: none;
    }

    .demo-banner.visible {
      display: block;
    }

    .demo-banner a {
      color: white;
      text-decoration: underline;
    }

    /* デモモード時のフォーム */
    .card.demo-disabled {
      opacity: 0.7;
      position: relative;
    }

    .card.demo-disabled::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 10px;
      cursor: not-allowed;
    }

    .demo-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 10;
      display: none;
    }

    .card.demo-disabled .demo-overlay {
      display: block;
    }

    .demo-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 12px;
      background: #fef3c7;
      color: #b45309;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>GCP Pub/Sub リアルタイム通知</h1>

    <div class="demo-banner" id="demoBanner">
      デモモードで動作中 - サンプル通知が自動的に表示されます。通知の送信はできません。
    </div>

    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">接続中...</span>
        <span class="pubsub-badge" id="pubsubBadge">Pub/Sub: -</span>
      </div>
      <div class="client-id" id="clientId">-</div>
    </div>

    <div class="card" id="notifyCard">
      <h2>通知を送信</h2>
      <div class="demo-overlay">デモモードでは送信できません</div>
      <form id="notifyForm">
        <div class="form-group">
          <label for="title">タイトル</label>
          <input type="text" id="title" placeholder="通知のタイトル">
        </div>
        <div class="form-group">
          <label for="message">メッセージ *</label>
          <textarea id="message" placeholder="通知メッセージを入力..." required></textarea>
        </div>
        <div class="form-group">
          <label for="type">通知タイプ</label>
          <select id="type">
            <option value="info">情報 (Info)</option>
            <option value="success">成功 (Success)</option>
            <option value="warning">警告 (Warning)</option>
            <option value="error">エラー (Error)</option>
          </select>
        </div>
        <div class="btn-group">
          <button type="submit" id="submitBtn">全員に送信</button>
          <button type="button" class="btn-secondary" onclick="clearNotifications()">通知をクリア</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2>受信した通知</h2>
      <div class="notifications-container" id="notifications">
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          <p>まだ通知はありません</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const clientId = `client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    let eventSource = null;
    let isConnected = false;
    let isDemoMode = false;

    function enableDemoMode() {
      isDemoMode = true;
      document.getElementById('demoBanner').classList.add('visible');
      document.getElementById('notifyCard').classList.add('demo-disabled');
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('title').disabled = true;
      document.getElementById('message').disabled = true;
      document.getElementById('type').disabled = true;
    }

    function updateStatus(connected) {
      isConnected = connected;
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');

      if (connected) {
        dot.className = 'status-dot connected';
        text.textContent = '接続済み';
      } else {
        dot.className = 'status-dot disconnected';
        text.textContent = '切断';
      }
    }

    function updatePubSubStatus(enabled) {
      const badge = document.getElementById('pubsubBadge');
      if (enabled) {
        badge.textContent = 'Pub/Sub: 有効';
        badge.className = 'pubsub-badge enabled';
      } else {
        badge.textContent = 'Pub/Sub: ローカル';
        badge.className = 'pubsub-badge disabled';
      }
    }

    function connect() {
      document.getElementById('clientId').textContent = clientId;

      eventSource = new EventSource(`/events?clientId=${clientId}`);

      eventSource.onopen = () => {
        console.log('SSE接続が開かれました');
      };

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('受信:', data);

          if (data.type === 'connected') {
            updateStatus(true);
            updatePubSubStatus(data.pubsubEnabled);
            // デモモードの場合はUIを無効化
            if (data.demoMode) {
              enableDemoMode();
            }
          } else if (data.type === 'notification') {
            addNotification(data.data);
          }
        } catch (error) {
          console.error('パースエラー:', error);
        }
      };

      eventSource.onerror = (error) => {
        console.error('SSEエラー:', error);
        updateStatus(false);

        // 再接続を試みる
        setTimeout(() => {
          if (!isConnected) {
            console.log('再接続を試みます...');
            connect();
          }
        }, 3000);
      };
    }

    function addNotification(notification) {
      const container = document.getElementById('notifications');

      // 空の状態を削除
      const emptyState = container.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }

      const time = new Date(notification.timestamp).toLocaleTimeString('ja-JP');

      const notificationEl = document.createElement('div');
      let sourceLabel = 'direct';
      let sourceClass = '';
      if (notification.source === 'pubsub' || notification.source === 'pubsub-push') {
        sourceLabel = 'via Pub/Sub';
        sourceClass = 'pubsub';
      } else if (notification.source === 'demo') {
        sourceLabel = 'demo sample';
        sourceClass = 'demo';
      }

      notificationEl.className = `notification ${notification.notificationType}`;
      notificationEl.innerHTML = `
        <div class="notification-header">
          <span class="notification-title">${escapeHtml(notification.title)}</span>
          <span class="notification-time">${time}</span>
        </div>
        <div class="notification-message">${escapeHtml(notification.message)}</div>
        <div class="notification-source ${sourceClass}">${sourceLabel}</div>
      `;

      container.insertBefore(notificationEl, container.firstChild);

      // ブラウザ通知
      if (Notification.permission === 'granted') {
        new Notification(notification.title, {
          body: notification.message,
          icon: '/favicon.ico'
        });
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function clearNotifications() {
      const container = document.getElementById('notifications');
      container.innerHTML = `
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          <p>まだ通知はありません</p>
        </div>
      `;
    }

    // 通知送信フォーム
    document.getElementById('notifyForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // デモモードでは送信しない
      if (isDemoMode) {
        alert('デモモードでは通知の送信はできません');
        return;
      }

      const title = document.getElementById('title').value;
      const message = document.getElementById('message').value;
      const type = document.getElementById('type').value;

      try {
        const response = await fetch('/notify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title, message, type })
        });

        const result = await response.json();
        if (result.demoMode) {
          alert('デモモードでは通知の送信はできません');
          return;
        }
        if (result.success) {
          document.getElementById('message').value = '';
          document.getElementById('title').value = '';
        }
      } catch (error) {
        console.error('送信エラー:', error);
        alert('通知の送信に失敗しました');
      }
    });

    // ブラウザ通知の許可を要求
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // 接続開始
    connect();

    // ページを離れる時に接続を閉じる
    window.addEventListener('beforeunload', () => {
      if (eventSource) {
        eventSource.close();
      }
    });
  </script>
</body>
</html>
